(defpackage :lateral
  (:use :cl))
(in-package :lateral)

;; (declaim (optimize (debug 3)))

(defparameter *register-count* 10)
(defparameter *built-ins* '(add))

(defmacro consf (new-head list)
  "Modifies a reference by consing a new value to it"
  `(setf ,list (cons ,new-head ,list)))

(defun compile-top (form)
  (destructuring-bind (ops var-count) (compile-form form)
    (format t "窿磲疸狎＇狍箦礅戾镳疱屦栾戾蝈玳篝弪犰祜汜翦镳鲠颦泔躅舂┅┅ㄤ彐躅泔眇殪瀛躅轸ㄦ矧愆换麸戾鲥汜徙沐痿溴骟犷溴骢铙换泔祆邈犰雉桢篝狒屙孱趔轭麸磲轭篝狎ㄦ矧磲窿ㄣ镱è铒ㄣ镱箴骘蝽┅ㄥ蝌矧汜瞌泔眇殪澧┅è羼ㄦ轵篝骘蝽т彐躅换ㄤ彐躅钺礤ㄡ蜱怙澌ㄩ戾铉翳翳轵骘蝽┅穿ㄥ蝌矧汜瞌泔眇殪骢钽糸镱鏖翳盹蝈翳犷疳蜥眢┅戾è狎绛孱鲩祜镳骘狎轭翳轵骘蝽骘骝镯泔祆邈ㄣ镱狎椹┅ㄡ蜱忾钿祜镳骘狎轭翳轵骘蝽骘骝镯泔祆邈啜盹椹椹┅┅ㄣ镱汜翦钺翦ъ轶扉篝ㄦ矧磲铋窿┖ヰ躞骛祢ア箦泔钿骘蝽┅换盹鲥狎珲礤铘骝镯蝈玳篝弪轭麸鲠蜷徕戾换泸遽翦忾钿轭镦狎珲礤铘鲠蜷徕戾ㄤ弩趄蹉趱蜷铉忾钿镳鲠蝮ㄣ镯痖戾骘蝽ㄦ秕螋骘蝽哄铞轵狎绛孱鲩忽狎铛戾铉翳翳轵骘蝽┅戾è镳ㄣ镱汜翦钺翦ъ轶狎绛忾钿镳螬┅磲疸狎＇狍箦礅戾镳疱屦栾戾蝈玳篝弪犰祜汜翦镳鲠蝮┅┅扉篝ㄦ矧磲铋痫骛祢モ祢ア┅┅ㄥ蝌矧汜瞌泔眇殪澧┅┅ㄤ彐躅泔眇殪瀛骘蝽ㄦ矧脲ㄥ铞轵铋飑鲠颦铛癌戾è鲠颦铛ū鲠颦铛愆灬暴ㄩ铙趄扉篝Ж┅灬忮祗è屙轸ㄦㄣ镱箧轭篝颦扉篝┅鲠啜┅麽祀ㄦ孱鲩镳糸镱犰蝈篚祠鲠铋飑戾è蝈篚祠ㄩ蝈篚祠鲠蝈篚祠鲠ㄩ钽鲠颦铛愆┅ㄣ镱è铛礅弪姗ㄥ黹啜盹蝈篚祠ㄣ镱篝姗┅蝈篚祠è簌礅镬姗ㄤ邈鲠颦铛愆簌礅镬祜镫躔滹弩铒铄邃铄鲠蜷徕戾换蝈趱蝾鲠蜷徕戾殇镦祜镫躔戾è祜镫躔ㄣ潋ㄡ篌镢孱鲩颟┅躅戾篌祜镫躔ㄥ蝌矧Ⅵ狎铒骘躅轭孱鲩立孱鲩颟祜镫躔┅è铒ㄣ镱箴姗ㄥ蝌矧⒚犷泔眇殪镦豉疱立豉疱镦姗┅è羼чㄦ轵篝姗戾è翦篝麽祀箦泔钿姗孱鲩颟ㄥ祗瀛灬ㄩ钽灬猢ㄥ钿灬ㄩ钽灬猢┅ㄥ黹啜犏灬屐箦灬猢翦篝┅麽祀翳轵姗孱鲩蝈篚祠翳孱怛犷汨ㄥ黹啜觏灬孱洵灬猢┅ㄥ黹啜灬屐箦灬猢麽祀ㄦ秕螋姗孱鲩蝈篚祠屐箦怛犷汨ㄥ黹啜灬孱洵灬猢蝈篚祠┅è犷ㄣ镱箴ㄦ轵篝姗ㄥъ犴怃ㄣ後姗┅换è灬礅溽换灬礅溽汜祆泸遽翦孱鲩蝻铐孱鏖翳忾钿轭犷泔眇殪怙澌ㄤ邈鲠颦铛愆灬礅溽弼犰踽糸镱滹弩铒铄邃铄鲠蜷徕戾戾è飙疳蜥眢箦泔钿ㄦ轵篝姗┅飙狎珞蝈篝姗飙怙澌翳轵ㄦ轵篝姗┅飙孱鲩孱鲩颟ㄡ篌弪ㄡ钿ㄣ镱箴飙疳蜥眢戾铉翳飙疳蜥眢戾铉翳飙狎珞┅┅换箝眭灬翦秕箪泔眇殪狎珲礤铘翦蝽犷泸遽翦孱鲩蝻铐孱祜镳骘疳蜥轭飙疳蜥眢骘狎轭飙狎珞换怩殪犰轶鏖翳鲠忾钿轭珞滹ㄣ镱箧ㄣ镱疳蜥麽祀狎孱鲩颟飙孱鲩颟麽祀飙怙澌飙孱鲩颟┅è礤礅弪ㄦ轵篝姗怩殪舡轭螵ㄥ黹ㄣ镱汜翦钺翦ъ轶扉篝ㄦ轵篝姗鲠蝈篚祠┅祜镳骘翦蝽轭ㄣ潋姗泔祆邈鲠麽祀翦蝽孱鲩颟┅┅蝈篚祠ㄡ篌弪冀戾铉翳蝈篝姗穿换泔眇殪狎珲礤铘犷盹鲥麸狎蝈玳篝弪祜镳骘蝈篥轭磲疸狎灬礅溽翦蝽麽祀翦蝽孱鲩颟蝈篝姗骘骝镯滹ㄥ黹啜盹椹蝈篥┅┅换篚怛秕糸铄汜祆ㄥ黹ㄣ镱汜翦钺翦ъ轶扉篝扉篝ф躅汜祆ㄦ轵篝姗Ж癌祜镳骘骝镯躔麸泔祆邈啜椹┅ㄥ黹啜盹蝈篚祠癌┅蝈篚祠┅┅换盹鲥蝈篚祠轭麸蝈趱蝾蝈玳篝弪ㄥ黹啜盹癌麽祀骘蝽孱鲩颟┅箦翩轭篝颦扉篝蝈鲥蝮轭篝颦扉篝┅｜祜镳骘轭篝轭轭篝颦扉篝骘骝镯怡滹ㄦ矧磲③凛窿ア轭篝颟扉篝轭篝颦扉篝ū鲠颦铛愆┅┅ㄤ彐躅鲠蜷徕戾翦蝽⒃弩趔殒犷镳翦蝽蝈痱弩孱趔鲠蜷徕戾ㄡ钿ㄣ镱箴翦蝽ㄥㄦ轵篝翦蝽雯┅ㄤ彐躅蝈玳篝弪翦蝽⒃弩趔殒犷镳翦蝽蝈痱弩孱趔蝈玳篝弪ㄡ钿ㄣ镱箴翦蝽ㄥㄦ轵篝翦蝽颟┅ㄤ彐磲泸躔溽翦轭翦蝣犰ㄩ赧祗箪雉镳铛愆⒄痄狒弩翳扉驽糸礤轭翦蝣犰扉篝鏖翳铄孱鲠祯瀹戾è箪雉ㄧ孱簌愆┅啜戾è箪雉箦泔钿箪雉┅ㄩㄦ轵篝ㄡ蝈轸鲮箪雉┅换躔溽翦孱镦屮轶糸铉轭翦蝣犰箦翩ㄦ轵篝ㄡ蝈轸鲮箪雉┅镳铛愆换翳弪麽栾戾篝狎铄箦泗轱箦翩ㄡ蝈轸鲮箪雉ㄣ镱镳铛ㄣ镱镳铛ㄡ蝈轸鲮箪雉┅┅┅┅ㄤ彐磲泸轭翦蝣犰栾戾ㄩ赧祗箪雉⒚蝈狒弩栾戾轭翳扉驽糸礤轭翦蝣犰啜殒ㄦ轵篝ㄡ蝈轸鲮箦泔钿箪雉┅ㄣ镱箧铋ㄡ蝈轸鲮箦泔钿箪雉┅┅ㄤ彐躅趄轫轭翦蝣犰ㄩ赧飑⒁弼弪箦扉篝犷蝈盹鲥戾徜轭犷趄衢扉铉铋祗灬忮祗è趄轫ㄩㄩㄦ轵篝椹趄轫蝈篝椹┅┅趄轫蝈鲥蝮趄轫轸鲮┅┅ㄤ彐躅鲠颦轭翦蝣犰镳扉篝鲠颦泔躅舂⒚犰沲灬翦鲠蜷徕戾扉驽糸礤轭翦蝣犰螽戾è鲠颦扉篝磲脲狎蜥鲠颦泔躅洪铋糸犰屐屙孱铋飑┅祜镳骘镳轭镳扉篝骘骝镯怡换鲠蜷徕戾轶躞邃狍狎珲礤铘屮翦钿翳扉驽镦鲠滹祜镳骘翦蝽轭铘桡潋镳麒孱鲠蜷徕戾翦蝽滹躔溽翦轭翦蝣犰鲠颦扉篝翦蝽椹换鲠蜷徕戾轶黩轸翦麸鲠麽痱弼轱躞禊溴徜麒孱鲠蜷徕戾箦泔钿镳┅滹痱镧ㄩ铘弪鲠飙栾戾鲠颦扉篝箦泔钿镳┅躔溽翦轭翦蝣犰鲠颦扉篝箦泔钿镳ū椹┅祜镳骘轸鲮徙蝻篌鲠颦扉篝骘骝镯泔祆邈ㄣ镱扉篝椹趄轫轭翦蝣犰轸鲮┅┅ㄤ彐躅蝈绛轭翦蝣犰镳扉篝⒚犰沲灬翦蝈玳篝弪扉驽糸礤轭翦蝣犰螽戾è蝈绛扉篝磲脲狎蜥蝈玳篝弪泔躅舄洪铋糸犰屐屙孱铋飑换ㄨ轭趔Ж┅麸滹栝铘痨徙屙孱镦蝈玳篝弪祜镳骘镳轭镳扉篝骘骝镯怡换蝈玳篝弪躞邃狍狎珲礤铘蝈玳篝弪轶溴徜滹祜镳骘翦蝽轭铘桡潋镳麒孱蝈玳篝弪翦蝽滹ㄩ铘弪鲠飙栾戾蝈绛扉篝翦蝽┅换蝈篚祠轶痨徙邃轭蝈玳篝弪蝈玳篝弪轶扉鲥麒孱蝈玳篝弪箦泔钿镳┅滹躔溽翦轭翦蝣犰蝈绛扉篝箦泔钿镳ū椹┅换骘蝽狒糸铉翳蝈玳篝弪扉驽糸礤麸忮扉脲翳鲠蜷徕戾螫祜镳骘蝈徙蝻篌蝈绛扉篝骘蜷骝镯麒孱蝈滹箦翩ㄡ蝈蝈绛扉篝蜷ㄣ镱趄轫轭翦蝣犰蝈绌┅蝈绛扉篝┅ㄤ彐躅轭翦蝣犰轭翦蝮邈趔ㄡ猢⒃弩趔殒赭扉驽糸礤轭翦蝣犰轭翦蝮邈舢灬忮祗è桢祓弪ㄣ镱è铒ㄡ钿┅铋飑è箦泔钿ㄦ轵篝┅ㄨ屐疱铘桡潋┅è箦泔钿ㄦ轵篝┅ㄨ屐疱铘桡潋┅舂┅ㄨ屐疱蝈篝岍蝈篝猢┅ㄤ彐躅蝈玳篝弪犰祜汜翦镳扉篝鲠颦泔躅舂⒘篌殓铙痂箝汜蝈玳篝弪麸遽汨鲠蜷徕戾轭镳扉篝戾è扉驽糸礤箫螋鲠颦轭翦蝣犰镳扉篝鲠颦泔躅舂＇弘妁＇箦泔钿┅蜢轹弩蝈绛轭翦蝣犰镳扉篝┅ㄡ泗轹Ж┅ㄡ篌殓铙Ж┅祜镳骘沲蝌轭扉驽糸礤滹戾è忪镢脲磲脲狎蜥蝈玳篝弪泔躅舄洪铋糸犰屐屙孱铋飑痫箦泔钿沲蝌┅铄鳝徙糸鲥Ж┅祜镳骘轸鲮轭徙糸鲥换躔溽翦徙糸鲥轭翦蝣犰铄沐篌狎咯滹ㄣ镱è翳轵轸鲮痫螬ㄣ镱箧轸鲮铄鳝徙糸鲥┅è铘桡潋轸鲮ㄣ镱箧ㄣ镱ㄦ轵篝轸鲮铘桡潋轸鲮┅铄鳝徙糸鲥┅换汨邈骘轭翦蝮邈糸镱麒孱ㄩ铘弪鲠飙轭翦蝮邈趔沲蝌轸鲮滹箦翩ㄡ蝈忪镢脲ㄦ轵篝轸鲮┅舂箦翩徙糸鲥铄鳝徙糸鲥戾è蝈祜镳骘蝈徙蝻篌忪镢脲骘蜷骝镯躅戾篌矧蝈ㄩ铘弪鲠飙轭翦蝮邈趔ㄡ蝈蜢轹弩蜷沲蝌┅蝈趱蝾蜷┅ㄩ蝈痱镧ㄩ蝈畅ㄥ蝌矧汜祆邋筢鲥蝈玳篝弪躅轫痨屙孱翦洧┅ㄣ镱箧ㄣ镱ㄣ徜狎沲蝌蝈螬狍箝珙螬ㄣ镱箧ㄣ镱蝈蝈篝沲蝌┅徙糸鲥┅ㄥ蝌矧Ⅱ彗轶翦箴殪躅轫痨屙孱翦洧┅┅祜镳骘镳轭镳扉篝泔祆邈祜镳骘翦蝽轭镳泔祆邈ㄩ鲠蜷徕戾翦蝽扉篝ㄣ潋ㄡ篌镢箦泔钿翦蝽狍箝珙螬┅翦蝽┅┅ㄤ彐躅疱屦栾戾镳扉篝⒘痧扉弩疱屦栾戾镳糸黹狒轱铙镱狍箦礅禊泔溴换骘蝽骢箦镳弪狒轱铙瀹绠轭翦蝽邃獒翦忾趔栝骠换泔蹯痱镡徕禊磲脲忮趑弪疱屦栾戾镳糸黹狒轱铙鏖翳扉鲥扉铄篌轭骘蝽狒轱换磲忮磲痨轶轶忮趑弪矧箝眇禊蝈沲蝮轱祜镳骘镳镱镳扉篝狃疱钿戾è沲蝌ㄦ轵篝镳螬┅ㄣ镱换溴戾翦盹镳弪狒轱铙殒箫躜沐溴篝è犷ㄥы秭ㄦ轵篝沲蝌┅ㄥ聃犰箦泔钿沲蝌翳轵沲蝌┅铋飑扉篝沲蝌┅┅┅ㄤ彐躅狍箦礅戾镳镳⒘篌屙忪弩烈统轭篝蝓泗轱铙骝镯轭礤盹蝙蝈痱弩孱翎糸镱灬忮祗è屙轸翦蝽翦蝽ㄦ矧磲铋ㄣ狍ㄦ轵篝翦蝽è颟Ⅱ立è泔铙舂⒔立è灬猢㈧徕屐立ㄥ蝌矧⒚犷狍箦礅戾翦蝽立翦蝽┅箦泔钿翦蝽┅┅ㄩㄡ钿ㄣ镱箴ㄦ轵篝镳┅ㄥф躅汜祆ㄣ後镳┅ㄦ矧磲铋⑩窿アㄣ徜狎镳┅ㄣ狍ㄦ轵篝镳è盹雯ㄦ矧磲铋ㄩㄡ钿ㄣ镱箴翳轵镳┅ㄥс镱篝ㄦ轵篝翳轵镳┅┅㈧潋窿蕃%"
		       "mov 窿蕃%")
		   (mapcar #'emit-term (cdr op))))
	  ((lab) (format nil "A: " (emit-term op)))
	  ((jmp) (format nil "b A%" (emit-term (second op))))
	  ((jz)  (format nil "cmp A, #0%beq A%"
			 (emit-term (third op))
			 (emit-term (second op))))
	  ((add) (format nil "add 窿蕃%" (mapcar #'emit-term (cdr op))))
	  (t (error "Can't assemble A" op))))))
